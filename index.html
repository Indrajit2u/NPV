<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trilogy NPV Calculator</title>
<style>
    :root { --bg: #f8fafc; --text: #1e293b; --card: #ffffff; --pri: #3b82f6; --acc: #10b981; }
    [data-theme="dark"] { --bg: #0f172a; --text: #e2e8f0; --card: #1e293b; --pri: #60a5fa; --acc: #34d399; }
    body { margin:0; font-family:system-ui; background:var(--bg); color:var(--text); min-height:100vh; display:flex; flex-direction:column; }
    header { padding:1rem; background:rgba(255,255,255,0.9); backdrop-filter:blur(10px); position:sticky; top:0; z-index:10; display:flex; justify-content:flex-end; gap:1rem; }
    .container { max-width:1400px; margin:auto; padding:1.5rem; flex:1; }
    h2 { text-align:center; font-size:2rem; background:linear-gradient(to right,var(--pri),var(--acc)); -webkit-background-clip:text; color:transparent; }
    .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:1rem; background:var(--card); padding:1.5rem; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.1); margin-bottom:1rem; }
    select, input { padding:0.75rem; border:1px solid #cbd5e1; border-radius:8px; font-size:1rem; background:transparent; color:var(--text); width:100%; }
    .milestones { display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; margin-top:1rem; }
    .section { background:var(--card); padding:1rem; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.08); }
    table { width:100%; border-collapse:collapse; }
    th { background:var(--pri); color:white; padding:0.75rem; }
    td { padding:0.5rem; border-bottom:1px solid #e2e8f0; }
    td input { width:100%; padding:0.5rem; border:1px solid #cbd5e1; border-radius:6px; }
    td input[readonly] { background:#f1f5f9; color:#64748b; cursor:not-allowed; }
    .btn { background:linear-gradient(to right,var(--pri),var(--acc)); color:white; border:none; padding:0.8rem 2rem; border-radius:8px; font-weight:600; cursor:pointer; margin:1.5rem auto; display:block; }
    .result { background:var(--card); padding:1.5rem; border-radius:12px; margin-top:1rem; box-shadow:0 4px 15px rgba(0,0,0,0.08); display:none; }
</style>
</head>
<body>

<div class="container">
    <h2>Trilogy NPV Calculator</h2>

    <div class="form-grid">
        <div><label>Project</label><select id="project" onchange="loadTowers()"><option>Loading...</option></select></div>
        <div><label>Tower</label><select id="tower" onchange="loadMilestones()"><option>Select project first</option></select></div>
        <div><label>Product Cost (₹)</label><input type="number" id="productCost" value="50000000" oninput="updateAllValues()"></div>
        <div><label>Interest Rate (%)</label><input type="number" id="interestRate" step="0.01" placeholder="e.g. 10.5"></div>
    </div>

    <div class="milestones">
        <div class="section"><h3>Actual (Locked)</h3><table><thead><tr><th>Milestone</th><th>Date</th><th>%</th><th>Value ₹</th></tr></thead><tbody id="actualBody"></tbody></table></div>
        <div class="section"><h3>Expected (Edit Dates)</h3><table><thead><tr><th>Milestone</th><th>Date</th><th>%</th><th>Value ₹</th></tr></thead><tbody id="expectedBody"></tbody></table></div>
    </div>

    <button class="btn" onclick="calculateNPV()">Calculate NPV</button>
    <div id="result" class="result"><h3>Result</h3><div id="resultContent"></div></div>
</div>

<script>
// THIS IS THE ONLY LINE YOU NEED TO CHANGE
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxvQhW6nHFQudPXTmmsXG8BxTmf4z8k6lSlQqB_6yg/dev";

async function loadProjects() {
    const res = await fetch(WEB_APP_URL + "?action=projects");
    const data = await res.json();
    const sel = document.getElementById("project");
    sel.innerHTML = "<option>Select Project</option>";
    data.projects.forEach(p => sel.add(new Option(p, p)));
    sel.value = "Trilogy"; loadTowers();
}
async function loadTowers() {
    const p = document.getElementById("project").value;
    const res = await fetch(`${WEB_APP_URL}?action=towers&project=${p}`);
    const data = await res.json();
    const sel = document.getElementById("tower");
    sel.innerHTML = "<option>Select Tower</option>";
    data.towers.forEach(t => sel.add(new Option(t, t)));
}
async function loadMilestones() {
    const p = document.getElementById("project").value;
    const t = document.getElementById("tower").value;
    const res = await fetch(`${WEB_APP_URL}?action=milestones&project=${p}&tower=${t}`);
    const data = await res.json();
    const cost = parseFloat(document.getElementById("productCost").value) || 50000000;

    const row = (m, editable) => `<tr>
        <td><input value="${m.MilestoneName}" readonly></td>
        <td><input type="date" value="${m.Date}" ${editable?'class="exp-date" onchange="updateValue(this)"':''}></td>
        <td><input value="${m.Billing}" readonly></td>
        <td><input value="${Math.round(m.Billing/100*cost)}" ${editable?'class="exp-value"':''} readonly></td>
    </tr>`;

    document.getElementById("actualBody").innerHTML = data.milestones.map(m => row(m, false)).join("");
    document.getElementById("expectedBody").innerHTML = data.milestones.map(m => row(m, true)).join("");
}

function updateValue(e) { updateAllValues(); }
function updateAllValues() {
    const cost = parseFloat(document.getElementById("productCost").value) || 0;
    document.querySelectorAll("tr").forEach(r => {
        const pct = parseFloat(r.cells[2].querySelector("input").value) || 0;
        r.cells[3].querySelector("input").value = Math.round(pct/100 * cost);
    });
}

function calculateNPV() {
    const rate = parseFloat(document.getElementById("interestRate").value)/100;
    const today = new Date(); today.setHours(0,0,0,0);
    let actual = 0, expected = 0;

    document.querySelectorAll("#actualBody tr").forEach(r => {
        const d = new Date(r.cells[1].querySelector("input").value);
        const v = parseFloat(r.cells[3].querySelector("input").value);
        actual += v / Math.pow(1+rate, (d-today)/(1000*60*60*24*365.25));
    });
    document.querySelectorAll("#expectedBody tr").forEach(r => {
        const d = new Date(r.cells[1].querySelector("input").value);
        const v = parseFloat(r.cells[3].querySelector("input").value);
        expected += v / Math.pow(1+rate, (d-today)/(1000*60*60*24*365.25));
    });

    const diff = actual - expected;
    document.getElementById("resultContent").innerHTML = `
        <p><strong>Actual NPV:</strong> ₹${actual.toFixed(0).toLocaleString('en-IN')}</p>
        <p><strong>Expected NPV:</strong> ₹${expected.toFixed(0).toLocaleString('en-IN')}</p>
        <p><strong>Difference:</strong> <span style="color:${diff>=0?'green':'red'}">₹${Math.abs(diff).toFixed(0).toLocaleString('en-IN')}</span></p>
    `;
    document.getElementById("result").style.display = "block";
}

window.onload = loadProjects;
</script>
</body>
</html>
