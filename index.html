<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trilogy NPV Calculator</title>
<style>
    :root { --bg: #f8fafc; --text: #1e293b; --card: #ffffff; --pri: #3b82f6; --acc: #10b981; --err: #ef4444; }
    [data-theme="dark"] { --bg: #0f172a; --text: #e2e8f0; --card: #1e293b; --pri: #60a5fa; --acc: #34d399; }
    body { margin:0; font-family: system-ui; background:var(--bg); color:var(--text); min-height:100vh; display:flex; flex-direction:column; }
    header { padding:1rem; background:rgba(255,255,255,0.9); backdrop-filter:blur(10px); position:sticky; top:0; z-index:10; display:flex; justify-content:flex-end; gap:1rem; }
    .container { max-width:1400px; margin:auto; padding:1.5rem; flex:1; }
    h2 { text-align:center; font-size:2rem; margin-bottom:1rem; background:linear-gradient(to right,var(--pri),var(--acc)); -webkit-background-clip:text; color:transparent; }
    .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:1rem; background:var(--card); padding:1.5rem; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.1); margin-bottom:1rem; }
    select, input { padding:0.75rem; border:1px solid #cbd5e1; border-radius:8px; font-size:1rem; background:transparent; color:var(--text); width:100%; }
    .milestones { display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; margin-top:1rem; }
    .section { background:var(--card); padding:1rem; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.08); }
    table { width:100%; border-collapse:collapse; margin-top:0.5rem; }
    th { background:var(--pri); color:white; padding:0.75rem; font-weight:600; }
    td { padding:0.5rem; border-bottom:1px solid #e2e8f0; }
    td input { width:100%; padding:0.5rem; border:1px solid #cbd5e1; border-radius:6px; }
    td input[readonly] { background:#f1f5f9; color:#64748b; cursor:not-allowed; }
    .btn { background:linear-gradient(to right,var(--pri),var(--acc)); color:white; border:none; padding:0.8rem 2rem; border-radius:8px; font-weight:600; cursor:pointer; margin:1.5rem auto; display:block; }
    .result { background:var(--card); padding:1.5rem; border-radius:12px; margin-top:1rem; box-shadow:0 4px 15px rgba(0,0,0,0.08); display:none; }
    footer { text-align:center; padding:1rem; color:#94a3b8; font-size:0.9rem; }
    .loading { color: var(--pri); font-style: italic; text-align: center; }
    .error { color: var(--err); }
</style>
</head>
<body>

<header>
    <button onclick="toggleTheme()" style="background:none;border:none;cursor:pointer;">
        <img src="https://img.icons8.com/ios-filled/50/ffffff/sun--v1.png" id="themeIcon" width="24">
    </button>
    <div style="width:36px;height:36px;border-radius:50%;background:var(--pri);color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:1.1rem;">T</div>
</header>

<div class="container">
    <h2>Trilogy NPV Calculator</h2>

    <div class="form-grid">
        <div>
            <label>Project</label>
            <select id="project" onchange="loadTowers()">
                <option value="">Loading projects...</option>
            </select>
        </div>
        <div>
            <label>Tower</label>
            <select id="tower" onchange="loadMilestones()">
                <option value="">First select project</option>
            </select>
        </div>
        <div>
            <label>Product Cost (₹) <small style="color:green;">← Editable</small></label>
            <input type="number" id="productCost" placeholder="e.g. 50000000" value="50000000" oninput="updateAllValues()">
        </div>
        <div>
            <label>Interest Rate (% p.a.)</label>
            <input type="number" id="interestRate" step="0.01" placeholder="e.g. 10.5" required>
        </div>
    </div>

    <div class="milestones">
        <div class="section">
            <h3>Actual Milestones (Locked)</h3>
            <table><thead><tr><th>Milestone</th><th>Date</th><th>Billing %</th><th>Value ₹</th></tr></thead>
            <tbody id="actualBody"><tr><td colspan="4" class="loading">Select Tower to load...</td></tr></tbody></table>
        </div>
        <div class="section">
            <h3>Expected Milestones (Edit Dates Only)</h3>
            <table><thead><tr><th>Milestone</th><th>Date</th><th>Billing %</th><th>Value ₹</th></tr></thead>
            <tbody id="expectedBody"><tr><td colspan="4" class="loading">Select Tower to load...</td></tr></tbody></table>
        </div>
    </div>

    <button class="btn" onclick="calculateNPV()">Calculate NPV</button>

    <div id="result" class="result">
        <h3>NPV Result</h3>
        <div id="resultContent"></div>
        <button class="btn" onclick="saveResult()" style="margin-top:1rem; padding:0.6rem 1.5rem; font-size:0.9rem;">Save Result to Sheet</button>
    </div>
</div>

<footer>© 2025 Trilogy NPV Calculator • Connected to Google Sheets</footer>

<script>
// CRITICAL FIX: You forgot quotes! This was breaking everything
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx-zgr0wClCBnvM8CJysUUgLHQXQgXFPf4g4-pfVjuLmx8CLlFVLyxGnNDzHRrLeZ-u/exec";

async function loadProjects() {
    try {
        const res = await fetch(`${WEB_APP_URL}?action=projects`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const sel = document.getElementById("project");
        sel.innerHTML = "<option value=''>Select Project</option>";
        (data.projects || []).forEach(p => sel.add(new Option(p, p)));
        if (data.projects?.includes("Trilogy")) {
            sel.value = "Trilogy";
            loadTowers();
        }
    } catch (e) {
        document.getElementById("project").innerHTML = `<option class="error">Error: ${e.message}</option>`;
        console.error("Load Projects Error:", e);
    }
}

async function loadTowers() {
    const proj = document.getElementById("project").value;
    const sel = document.getElementById("tower");
    sel.innerHTML = "<option>Loading towers...</option>";
    if (!proj) { sel.innerHTML = "<option>First select project</option>"; return; }

    try {
        const res = await fetch(`${WEB_APP_URL}?action=towers&project=${encodeURIComponent(proj)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        sel.innerHTML = "<option value=''>Select Tower</option>";
        (data.towers || []).forEach(t => sel.add(new Option(t, t)));
    } catch (e) {
        sel.innerHTML = `<option class="error">Error: ${e.message}</option>`;
        console.error("Load Towers Error:", e);
    }
}

async function loadMilestones() {
    const proj = document.getElementById("project").value;
    const tower = document.getElementById("tower").value;
    if (!proj || !tower) return;

    document.getElementById("actualBody").innerHTML = "<tr><td colspan='4' class='loading'>Loading milestones...</td></tr>";
    document.getElementById("expectedBody").innerHTML = "<tr><td colspan='4' class='loading'>Loading...</td></tr>";

    try {
        const res = await fetch(`${WEB_APP_URL}?action=milestones&project=${encodeURIComponent(proj)}&tower=${encodeURIComponent(tower)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        const cost = parseFloat(document.getElementById("productCost").value) || 50000000;

        const renderRow = (m, editableDate = false) => `
            <tr>
                <td><input value="${m.MilestoneName || ''}" readonly></td>
                <td><input type="date" value="${m.Date || ''}" ${editableDate ? 'class="exp-date" onchange="updateValue(this)"' : 'readonly'}></td>
                <td><input value="${m.Billing || 0}" readonly></td>
                <td><input value="${Math.round((m.Billing || 0)/100 * cost)}" ${editableDate ? 'class="exp-value"' : ''} readonly></td>
            </tr>`;

        const actualHTML = (data.milestones || []).map(m => renderRow(m, false)).join("") || "<tr><td colspan='4'>No data</td></tr>";
        const expectedHTML = (data.milestones || []).map(m => renderRow(m, true)).join("") || "<tr><td colspan='4'>No data</td></tr>";

        document.getElementById("actualBody").innerHTML = actualHTML;
        document.getElementById("expectedBody").innerHTML = expectedHTML;
    } catch (e) {
        const err = `<tr><td colspan='4' class="error">Error: ${e.message}</td></tr>`;
        document.getElementById("actualBody").innerHTML = err;
        document.getElementById("expectedBody").innerHTML = err;
        console.error("Load Milestones Error:", e);
    }
}

function updateValue(input) {
    const row = input.closest("tr");
    const billing = parseFloat(row.cells[2].querySelector("input").value) || 0;
    const cost = parseFloat(document.getElementById("productCost").value) || 0;
    row.querySelector(".exp-value").value = Math.round(billing/100 * cost);
}

function updateAllValues() {
    const cost = parseFloat(document.getElementById("productCost").value) || 0;
    document.querySelectorAll("#actualBody tr, #expectedBody tr").forEach(row => {
        const billing = parseFloat(row.cells[2].querySelector("input").value) || 0;
        const valueInput = row.cells[3].querySelector("input");
        valueInput.value = Math.round(billing/100 * cost);
    });
}

function calculateNPV() {
    const rate = parseFloat(document.getElementById("interestRate").value) / 100;
    if (!rate || rate <= 0) return alert("Please enter a valid interest rate");

    const today = new Date(); today.setHours(0,0,0,0);
    let actualNPV = 0, expectedNPV = 0;

    document.querySelectorAll("#actualBody tr").forEach(row => {
        const date = new Date(row.cells[1].querySelector("input").value);
        const value = parseFloat(row.cells[3].querySelector("input").value) || 0;
        if (!isNaN(date) && value) {
            const years = (date - today) / (1000*60*60*24*365.25);
            actualNPV += value / Math.pow(1 + rate, years);
        }
    });

    document.querySelectorAll("#expectedBody tr").forEach(row => {
        const date = new Date(row.cells[1].querySelector("input").value);
        const value = parseFloat(row.cells[3].querySelector("input").value) || 0;
        if (!isNaN(date) && value) {
            const years = (date - today) / (1000*60*60*24*365.25);
            expectedNPV += value / Math.pow(1 + rate, years);
        }
    });

    const diff = actualNPV - expectedNPV;
    const pct = expectedNPV ? (diff / expectedNPV * 100).toFixed(2) : 0;

    document.getElementById("resultContent").innerHTML = `
        <p><strong>Actual NPV:</strong> ₹${actualNPV.toFixed(0).toLocaleString('en-IN')}</p>
        <p><strong>Expected NPV:</strong> ₹${expectedNPV.toFixed(0).toLocaleString('en-IN')}</p>
        <p><strong>Difference:</strong> <span style="color:${diff>=0?'green':'red'}">₹${Math.abs(diff).toFixed(0).toLocaleString('en-IN')}</span> ${diff >= 0 ? '(Gain)' : '(Loss)'}</p>
        <p><strong>Impact:</strong> <span style="color:${diff>=0?'green':'red'}">${pct > 0 ? '+' : ''}${pct}%</span></p>
    `;
    document.getElementById("result").style.display = "block";
}

async function saveResult() {
    if (!confirm("Save this calculation to Google Sheets?")) return;

    const payload = {
        action: "saveResult",
        project: document.getElementById("project").value,
        tower: document.getElementById("tower").value,
        productCost: document.getElementById("productCost").value,
        interestRate: document.getElementById("interestRate").value,
        timestamp: new Date().toLocaleString('en-IN')
    };

    try {
        await fetch(WEB_APP_URL, {
            method: "POST",
            body: JSON.stringify(payload),
            headers: { "Content-Type": "text/plain" }
        });
        alert("Result saved to NPV_Results sheet!");
    } catch (e) {
        alert("Save failed: " + e.message);
    }
}

function toggleTheme() {
    const isDark = document.body.getAttribute("data-theme") === "dark";
    document.body.setAttribute("data-theme", isDark ? "light" : "dark");
}

window.onload = loadProjects;
</script>
</body>
</html>
